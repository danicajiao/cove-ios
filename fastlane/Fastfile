# Fastlane configuration for Cove iOS app

default_platform(:ios)

platform :ios do
  
  # Configuration
  APP_NAME = "Cove"
  WORKSPACE = "Cove.xcworkspace"
  SCHEME = "Cove"
  BUNDLE_ID = "com.danicajiao.Cove"
  
  desc "Increment build number"
  lane :bump_build do
    increment_build_number(
      build_number: latest_testflight_build_number + 1,
      xcodeproj: "Cove.xcodeproj"
    )
  end
  
  desc "Build the app for testing"
  lane :build do
    cocoapods
    
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Debug",
      export_method: "development",
      skip_codesigning: true,
      skip_package_ipa: true
    )
  end
  
  desc "Run tests"
  lane :test do
    run_tests(
      workspace: WORKSPACE,
      scheme: SCHEME,
      device: "iPhone 15",
      code_coverage: true
    )
  end
  
  desc "Build and deploy to TestFlight"
  lane :beta do
    # Ensure we have the latest pods
    cocoapods
    
    # Increment build number based on TestFlight
    bump_build
    
    # Build the app
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          BUNDLE_ID => ENV["PROVISIONING_PROFILE_SPECIFIER"]
        }
      }
    )
    
    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      distribute_external: false,
      changelog: "New build from CI/CD"
    )
    
    # Commit and push the version bump
    commit_version_bump(
      message: "Bump build number to #{lane_context[SharedValues::BUILD_NUMBER]}",
      xcodeproj: "Cove.xcodeproj"
    )
    
    push_to_git_remote
  end
  
  desc "Build and submit to App Store"
  lane :release do |options|
    # Ensure we have the latest pods
    cocoapods
    
    # Get version from options or use current
    version = options[:version]
    if version
      increment_version_number(
        version_number: version,
        xcodeproj: "Cove.xcodeproj"
      )
    end
    
    # Increment build number based on TestFlight
    bump_build
    
    # Build the app
    build_app(
      workspace: WORKSPACE,
      scheme: SCHEME,
      configuration: "Release",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          BUNDLE_ID => ENV["PROVISIONING_PROFILE_SPECIFIER"]
        }
      }
    )
    
    # Upload to App Store Connect
    upload_to_app_store(
      skip_metadata: false,
      skip_screenshots: true,
      submit_for_review: false,
      automatic_release: false,
      force: true
    )
  end
  
  desc "Run linting"
  lane :lint do
    swiftlint(
      mode: :lint,
      strict: true,
      raise_if_swiftlint_error: true,
      config_file: ".swiftlint.yml"
    )
  end
  
  # Error handling
  error do |lane, exception|
    UI.error("Error in lane #{lane}: #{exception}")
  end
  
end
